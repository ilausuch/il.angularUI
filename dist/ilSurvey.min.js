/**
LICENSE MIT 2015 ilausuch@gmail.com	
*/

angular.module("il.ui.survey", ['ngSanitize','pascalprecht.translate','ui.bootstrap'])
	.directive('ilSurvey', function() {
		var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs) {
			if ($scope.sendMessage==undefined)
				$scope.sendMessage="You are about to send your survey, are you sure?";
			
			if ($scope.divideSections==undefined)
				$scope.divideSections=true;
				
			if ($scope.useAwesomeIcons==undefined)
				$scope.useAwesomeIcons=true;
				
			if ($scope.radioIconSelected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.radioIconSelected="fa fa-dot-circle-o";
				else
					$scope.radioIconSelected="glyphicon glyphicon-check";
			
			if ($scope.radioIconUnselected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.radioIconUnselected="fa fa-circle-thin";
				else
					$scope.radioIconUnselected="glyphicon glyphicon-unchecked";
					
			if ($scope.starIconSelected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.starIconSelected="fa fa-star";
				else
					$scope.starIconSelected="glyphicon glyphicon-star";
			
			if ($scope.starIconUnselected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.starIconUnselected="fa fa-star-o";
				else
					$scope.starIconUnselected="glyphicon glyphicon-star-empty";
				
			if ($scope.checkboxIconSelected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.checkboxIconSelected="fa fa-check-square-o";
				else
					$scope.radioIconSelected="glyphicon glyphicon-check";
			
			if ($scope.checkboxIconUnselected==undefined)
				if ($scope.useAwesomeIcons)
					$scope.checkboxIconUnselected="fa fa-square-o";
				else
					$scope.radioIconUnselected="glyphicon glyphicon-unchecked";
				
			if ($scope.optionalText==undefined)
				$scope.optionalText="(optional)";
				
			if ($scope.requiredErrorText==undefined)
				$scope.requiredErrorText="This question is required";
				
			$scope.showValidation=true;
			
			
			$scope.resetAll=function(){
				$scope.result={};
				
				if ($scope.previousValues!=undefined)
					for (i in $scope.previousValues)
						$scope.result[i]=$scope.previousValues[i];
				
				if ($scope.model==undefined)
					return;
					
				$scope.currentSection=$scope.model.sections[0];
				
				$scope.model.sections.forEach(function(section){
					section.questions.forEach(function(question){
						if (question.uid==undefined)
							question.uid=Math.floor(Math.random()*1000000)
						
						if ($scope.result[question.uid]==undefined){
							$scope.result[question.uid]={}
							if (question.type=="multiselect"){
								question.options.forEach(function(option){
									$scope.result[question.uid][option.value]={value:false};
								})
							}
						}
					})
				})
			}
			
			$scope.$watch('reset', function() {
				$scope.resetAll();
			})
			
			$scope.$watch('model', function() {
				$scope.resetAll();
			})
			
			
			$scope.resetAll();
			
			
			$scope._checkQuestion=function(question){
				if (question.required==undefined || !question.required)
					return 1;
					
				if (!$scope.checkVisibleQuestion(question))
					return 1;
				
				var result=$scope.result[question.uid];
					
				var commentsVerification=1;
				
				if (question.commentsRequired!=undefined && question.commentsRequired){
					if (result.questionComments==undefined || result.questionComments=="")
						commentsVerification=0;
					else
						if (question.commentsVerify==undefined || question.commentsVerify(result.questionComments))
							commentsVerification=1;
						else
							return -1;
				}
					
					
				switch(question.type){
					case "select":
					case "combobox":
						if (result.value==undefined || result.value=="")
							return 0;
						
						var option=undefined;
						for (var i in question.options)
							if (question.options[i].value==result.value){
								option=question.options[i];
								break;
							}
							
						if (option==undefined)
							return 0;
							
						if (option.commentsRequired!=undefined && option.commentsRequired==true){
							if (result.optionComments==undefined || result.optionComments=="")
								return 0;
							else
								if (option.commentsVerify==undefined || option.commentsVerify(result.optionComments))
									if (commentsVerification)
										return 1;
									else
										return 0;
								else
									return -1;
						}

							
						return 1;
					break;
					
					case "multiselect":
						var count=0;
						var verified=0;
						
						for(var i in result){
							if (result[i].value!=undefined && result[i].value){
								count++;
								
								var option=undefined;
								for (var j in question.options)
									if (question.options[j].value==result[i].value){
										option=question.options[j];
										break;
									}
									
									
								if (option!=undefined && option.commentsRequired!=undefined && option.commentsRequired==true){
									if (result[i].comments==undefined || result[i].comments==""){
										
									}
									else
										if (option.commentsVerify==undefined || option.commentsVerify(result[i].comments))
											verified++;									
										else
											return -1;
								}
								else
									verified++;
							}
						}
						
						
						if (question.min==undefined)
							return count>0 && commentsVerification && verified==count;
						else
							return count>=question.min && commentsVerification && verified==count;
					break;
					
					case "text":
						if (result.value==undefined || result.value=="")
							return 0;
							
						if (question.verify==undefined || question.verify(result.value))
							return 1;
						else
							return -1;
							
					break;
					
					case "table-select":
						
						for (var rowi in question.rows){
							var row=question.rows[rowi];
							var found=false;
							
							for (var ri in result)
								if (ri==row.uid && result[ri].value!=undefined)
									found=true;	
									
							if (!found)
								return -1;
						}
						
						return 1;
					break;
				}
				
				return 0;
			}
			
			$scope.checkQuestion=function(question){
				return $scope._checkQuestion(question)==1;
			}
			
			$scope.checkQuestionError=function(question){
				return $scope._checkQuestion(question)==-1;
			}
			
			$scope.checkQuestionDefault=function(question){
				return $scope._checkQuestion(question)==0;
			}

			$scope.checkVisibleQuestion=function(question){
				if (question.visibleFnc!=undefined){
					return question.visibleFnc({result:$scope.result});
				}else
					return true;
			}
			
			$scope.checkVisibleSection=function(section){
				var someQuestionVisible=false;
				for (i in section.questions)
					if ($scope.checkVisibleQuestion(section.questions[i])){
						someQuestionVisible=true;
						break;
					}
					
				if (!someQuestionVisible)
					return false;

				if (section.visibleFnc!=undefined)
					return section.visibleFnc({result:$scope.result});
				else
					return true;
			}
			
			
			
			$scope.checkSection=function(section){
				if (section!=undefined){
					if (section.questions!=undefined && $scope.checkVisibleSection(section))
						for (i in section.questions)
							if (!$scope.checkQuestion(section.questions[i])){
								return false;
								break;
							}
							
					return true;
				}
				else{
					if ($scope.model==undefined)
						return false;
						
					for (s in $scope.model.sections){
						var section=$scope.model.sections[s];
						for (i in section.questions)
							if (!$scope.checkQuestion(section.questions[i])){
								return false;
								break;
							}
					}
					
					return true;
				}
			}
			
			$scope.getSectionIndex=function(section){
				for (var i in $scope.model.sections)
					if ($scope.model.sections[i]==section)
						return Math.floor(i);
						
				return -1;
			}
			
			$scope.isFirstSection=function(){
				return $scope.getSectionIndex($scope.currentSection)==0;
			}
			
			$scope.isLastSection=function(){
				return $scope.getSectionIndex($scope.currentSection)==$scope.model.sections.length-1;
			}
			
			$scope.goNextSection=function(){
				if ($scope.isLastSection($scope.currentSection))
					return;
				window.test=$scope.model.sections
				$scope.currentSection=$scope.model.sections[$scope.getSectionIndex($scope.currentSection)+1];
			}
			
			$scope.goPreviousSection=function(){
				if ($scope.isFirstSection($scope.currentSection))
					return;
					
				$scope.currentSection=$scope.model.sections[$scope.getSectionIndex($scope.currentSection)-1];
			}
			
			$scope.send=function(){
				if (!confirm($scope.sendMessage))
					return;
					
				if ($scope.onFinish!=undefined)
					$scope.onFinish({result:$scope.result});
				
				$scope.currentSection=-1;
			}
			
			$scope.multiSelectClick=function(question,option){
				if ($scope.result[question.uid]==undefined)
					$scope.result[question.uid]={}
				
				if ($scope.result[question.uid][option.value]==undefined)
					$scope.result[question.uid][option.value]={value:true}
				else
					$scope.result[question.uid][option.value].value=!$scope.result[question.uid][option.value].value;
			}
			
			$scope.tableSelectClick=function(question,row,column){
				if ($scope.result[question.uid]==undefined)
					$scope.result[question.uid]={}
				
				$scope.result[question.uid][row.uid]={value:column.value}
			}
			
			$scope.starClick=function(question,row,option){
				if ($scope.result[question.uid]==undefined)
					$scope.result[question.uid]={}
				
				$scope.result[question.uid][row.uid]={value:option.value}
			}
			
			
		}];
		
		template='<div class="ilSurvey"> <div ng-if="model.survey.preHeader" class="preHeader"> <div ng-if="model.survey.preHeader.html" class="html" ng-bind-html="model.survey.preHeader.html"></div> <div ng-if="model.survey.preHeader.template" class="template" ng-include="model.survey.preHeader.template"></div> </div> <div ng-if="model.survey.header" class="header"> <div class="title" ng-bind-html="model.survey.header.title"></div> </div> <div ng-if="model.survey.postHeader" class="postHeader"> <div ng-if="model.survey.postHeader.html" class="html" ng-bind-html="model.survey.postHeader.html"></div> <div ng-if="model.survey.postHeader.template" class="template" ng-include="model.survey.postHeader.template"></div> </div> <div ng-repeat="(sectionNumber,section) in model.sections" ng-if="(currentSection==section || !divideSections) && checkVisibleSection(section)" class="section"> <div class="header"> <div class="title"> <span ng-if="autoNumber || autoSectionNumber">{{sectionNumber+1}}. </span> <span ng-bind-html="section.title"></span> </div> <div ng-if="section.description" class="staticHTML" ng-bind-html="section.description"></div> <div ng-if="section.template" class="staticTemplate" ng-include="section.template"></div> </div> <div ng-repeat="(questionNumber,question) in section.questions" class="question" ng-if="checkVisibleQuestion(question)"> <div ng-if="question.type!=\'label\' && question.type!=\'template\'" class="normal"> <span ng-if="autoNumber || autoQuestionNumber">{{sectionNumber+1}}.{{questionNumber+1}}. </span> <span ng-bind-html="question.title" class="title"></span> <span ng-if="!question.required">{{optionalText}}</span> <span ng-if="checkQuestion(question)" class="fa fa-check check"></span> <div ng-bind-html="question.description" class="description"></div> <div ng-if="!checkQuestion(question) && showValidation" class="error"><span class="fa fa-exclamation-triangle"></span> {{question.verifyText||question.verfyTextFnc(result[question.uid])||requiredErrorText}}</div> <div class="body"> <div ng-if="question.type==\'text\'" class="text"> <textarea ng-if="!question.rows || question.rows>1" placeholder="{{question.placeholder}}" style="width: 100%" ng-model="result[question.uid].value" rows="{{question.rows||4}}" class="text multipleRow"></textarea> <input ng-if="question.rows && question.rows==1" placeholder="{{question.placeholder}}" style="width: 100%" ng-model="result[question.uid].value" class="text oneRow"> </div> <div ng-if="question.type==\'select\'" class="select"> <div ng-repeat="option in question.options"> <div class="item" style="cursor:pointer" ng-click="result[question.uid].value=option.value"> <!-- <input type="radio" name="question_{{question.uid}}" value="{{option.value}}" ng-model="result[question.uid].value"> --> <span class="{{radioIconSelected}} icon" aria-hidden="true" ng-if="option.value==result[question.uid].value"></span> <span class="{{radioIconUnselected}} icon" aria-hidden="true" ng-if="option.value!=result[question.uid].value"></span> <span class="text">{{option.title}}</span> </div> <div ng-if="option.comments && result[question.uid].value==option.value" class="comment"> <span class="label" ng-if="option.commentsTitle">{{option.commentsTitle}}</span> <textarea ng-if="!option.commentsRows || option.commentsRows>1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].comments" rows="{{option.commentsRows||4}}" class="text multipleRow"></textarea> <input ng-if="option.commentsRows==1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].optionComments" class="text oneRow"> </div> </div> </div> <div ng-if="question.type==\'combobox\'" class="combobox"> <select ng-model="result[question.uid].value" ng-options="item.value as item.title for item in question.options"></select> <div ng-repeat="option in question.options" ng-if="option.comments && result[question.uid].value==option.value" class="comment"> <span class="label" ng-if="option.commentsTitle">{{option.commentsTitle}}</span> <textarea ng-if="!option.commentsRows || option.commentsRows>1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].comments" rows="{{option.commentsRows||4}}" class="text multipleRow" class="commentText commentOneRow"></textarea> <input ng-if="option.commentsRows==1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].optionComments" class="text oneRow"> </div> </div> <div ng-if="question.type==\'multiselect\'" class="multiselect"> <div ng-repeat="option in question.options" class="item"> <div ng-click="multiSelectClick(question,option)" style="cursor:pointer"> <!--<input type="checkbox" name="question_{{question.uid}}" value="{{option.value}}" ng-model="result[question.uid][option.value].value">--> <span class="{{checkboxIconSelected}} icon" aria-hidden="true" ng-if="result[question.uid][option.value].value"></span> <span class="{{checkboxIconUnselected}} icon" aria-hidden="true" ng-if="!result[question.uid][option.value].value"></span> {{option.title}} </div> <div ng-if="option.comments && result[question.uid][option.value].value" class="comment"> <!-- <textarea placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid][option.value].comments" rows="4"></textarea> --> <span class="label" ng-if="option.commentsTitle">{{option.commentsTitle}}</span> <textarea ng-if="!option.commentsRows || option.commentsRows>1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid][option.value].comments" rows="{{option.commentsRows||4}}" class="text multipleRow"></textarea> <input ng-if="option.commentsRows==1" placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid][option.value].optionComments" class="text oneRow"> </div> </div> </div> <div ng-if="question.type==\'table-select\'" class="tableSelect"> <table> <thead> <tr> <th></th> <th ng-repeat="column in question.columns" class="question_{{question.uid}}_column_{{column.value}}_title"> {{column.title}} </th> </tr> </thead> <tbody> <tr ng-repeat="row in question.rows"> <td> {{row.title}} </td> <td ng-repeat="column in question.columns" class="rowItem question_{{question.uid}}_column_{{column.value}}_item"> <span class="{{radioIconSelected}} icon" aria-hidden="true" ng-if="result[question.uid][row.uid].value==column.value"></span> <span class="{{radioIconUnselected}} icon" aria-hidden="true" ng-if="result[question.uid][row.uid].value!=column.value" ng-click="tableSelectClick(question,row,column)"></span> </td> </tr> </tbody> </table> </div> <div ng-if="question.type==\'stars\'" class="stars"> <table> <tbody> <tr ng-repeat="row in question.rows"> <td> {{row.title}} </td> <td class="rowItem question_{{question.uid}}" nowrap="nowrap"> <span ng-repeat="option in question.options"> <span class="{{starIconSelected}} icon star-on" aria-hidden="true" ng-if="result[question.uid][row.uid].value>=option.value" ng-click="starClick(question,row,option)" tooltip="{{option.tooltip}}"></span> <span class="{{starIconUnselected}} icon star-off" aria-hidden="true" ng-if="!result[question.uid][row.uid].value || result[question.uid][row.uid].value<option.value" ng-click="starClick(question,row,option)" tooltip="{{option.tooltip}}"></span> </span> </td> </tr> </tbody> </table> </div> </div> </div> <div ng-if="question.type==\'label\'" class="staticHTML" ng-bind-html="question.html"></div> <div ng-if="question.type==\'template\'" class="staticTemplate" ng-include="question.template"></div> </div> <div class="footer" ng-if="section.footer"> <div ng-if="section.footer.html" class="staticHTML" ng-bind-html="section.footer.html"></div> <div ng-if="section.footer.template" class="staticTemplate" ng-include="section.footer.template"></div> </div> <div style="text-align: center" ng-if="divideSections"> <button class="btn btn-primary" ng-if="!isFirstSection()" ng-click="goPreviousSection()"><span class="glyphicon glyphicon-chevron-left"></span> {{previousText||\'Previous\'|translate}}</button> <button class="btn" ng-if="!isLastSection()" ng-class="{\'btn-primary\':checkSection(section)}" ng-disabled="!checkSection(section)" ng-click="goNextSection()">{{nextText||\'Next\'|translate}} <span class="glyphicon glyphicon-chevron-right"></span></button> <button class="btn" ng-if="isLastSection()" ng-class="{\'btn-primary\':checkSection(section)}" ng-disabled="!checkSection(section)" ng-click="send()">{{finishText||\'Finish\'|translate}} <span class="glyphicon glyphicon-send"></span></button> </div> </div> <div style="text-align: center" ng-if="!divideSections"> <button class="btn" ng-class="{\'btn-primary\':checkSection()}" ng-disabled="!checkSection(section)" ng-click="send()">{{finishText||\'Finish\'|translate}} <span class="glyphicon glyphicon-send"></span></button> <button class="btn" ng-click="onCancel()" ng-if="canCancel">{{cancelText||\'Cancel\'|translate}} </div> </div></div>';
		
		return {
			restrict: 'E',
			scope: {
				model:'=',	
				previousValues:'=?',
				result:'=?',
				sendMessage:"=?",
				onFinish:"&",
				reset:"=?",
				divideSections:"=?",
				useAwesomeIcons:"=?",
				radioIconSelected:"=?",
				radioIconUnselected:"=?",
				checkboxIconSelected:"=?",
				checkboxIconUnselected:"=?",
				starIconSelected:"=?",
				starIconUnselecetd:"=?",
				optionalText:"=?",
				requiredErrorText:"=?",
				previousText:"=?",
				nextText:"=?",
				finishText:"=?",
				canCancel:"=?",
				cancelText:"=?",
				onCancel:"&",
				autoNumber:"=?",
				autoSectionNumber:"=?",
				autoQuestionNumber:"=?"
			},
			controller: controller,
			template:template
		};
	})