/**
LICENSE MIT 2015 ilausuch@gmail.com	
*/

angular.module("il.ui.survey", ['ngSanitize','pascalprecht.translate','ui.bootstrap'])
	.directive('ilSurvey', function() {
		var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs) {
			if ($scope.sendMessage==undefined)
				$scope.sendMessage="You are about to send your survey, are you sure?";
			
			$scope.resetAll=function(){
				$scope.result={};
				
				if ($scope.previousValues!=undefined)
					for (i in $scope.previousValues)
						$scope.result[i]=$scope.previousValues[i];
				
				$scope.currentSection=$scope.model.sections[0];
				
				$scope.model.sections.forEach(function(section){
					section.questions.forEach(function(question){
						if (question.uid==undefined)
							question.uid=Math.floor(Math.random()*1000000)
						
						if (!$scope.result[question.uid])
							$scope.result[question.uid]={}
					})
				})
			}
			
			$scope.$watch('reset', function() {
				$scope.resetAll();
			})
			
			
			
			$scope.resetAll();
			
			$scope.checkQuestion=function(question){
				if (question.required==undefined ||Â !question.required)
					return true;
				
				var result=$scope.result[question.uid];
					
				if (question.commentsRequired!=undefined && question.commentsRequired && (result.questionComments==undefined || result.questionComments==""))
					return false;
					
				switch(question.type){
					case "select":
						if (result.value==undefined || result.value=="")
							return false;
						
						var option=undefined;
						for (var i in question.options)
							if (question.options[i].value==result.value){
								option=question.options[i];
								break;
							}
						if (option==undefined)
							return false;
						
						if (option.commentsRequired!=undefined && option.commentsRequired==true && 
							(result.comments==undefined || result.comments==""))
							return false;
							
						return true;
					break;
					case "multiselect":
						var count=0;
						for(var i in result){
							if (result[i].value!=undefined && result[i].value)
								count++;
						}
						if (question.min==undefined)
							return count>0;
						else
							return count>=question.min;
					break;
					case "text":
						return $result.value!=undefined && result.value!="";
					break;
				}
			}
			
			$scope.checSection=function(section){
				for (i in section.questions)
					if (!$scope.checkQuestion(section.questions[i])){
						return false;
						break;
					}
						
				return true;
			}
			
			$scope.getSectionIndex=function(section){
				for (var i in $scope.model.sections)
					if ($scope.model.sections[i]==section)
						return Math.floor(i);
						
				return -1;
			}
			
			$scope.isFirstSection=function(){
				return $scope.getSectionIndex($scope.currentSection)==0;
			}
			
			$scope.isLastSection=function(){
				return $scope.getSectionIndex($scope.currentSection)==$scope.model.sections.length-1;
			}
			
			$scope.goNextSection=function(){
				if ($scope.isLastSection($scope.currentSection))
					return;
				window.test=$scope.model.sections
				console.debug("current",$scope.getSectionIndex($scope.currentSection),$scope.getSectionIndex($scope.currentSection)+1,$scope.currentSection,$scope.model.sections);
				$scope.currentSection=$scope.model.sections[$scope.getSectionIndex($scope.currentSection)+1];
				console.debug("current",$scope.getSectionIndex($scope.currentSection),$scope.currentSection);
			}
			
			$scope.goPreviousSection=function(){
				if ($scope.isFirstSection($scope.currentSection))
					return;
					
				$scope.currentSection=$scope.model.sections[$scope.getSectionIndex($scope.currentSection)-1];
			}
			
			$scope.send=function(){
				if (!confirm($scope.sendMessage))
					return;
					
				if ($scope.onFinish!=undefined)
					$scope.onFinish({result:$scope.result});
				
				$scope.currentSection=-1;
			}
		}];
		
		template='<div> <div ng-repeat="section in model.sections" ng-if="currentSection==section"> <div class="alert alert-info" role="alert"> <h2>{{section.title}}</h2> <p ng-if="section.description"> {{section.description}} </p> </div> <div class="panel" ng-class={\'panel-success\':checkQuestion(question),\'panel-default\':!checkQuestion(question)} ng-repeat="question in section.questions"> <div class="panel-heading">{{question.title}} <p ng-if="question.description"> <i>{{question.description}}</i> </p> </div> <div class="panel-body"> <div ng-if="question.type==\'select\'"> <div ng-repeat="option in question.options"> <div><input type="radio" name="question_{{question.uid}}" value="{{option.value}}" ng-model="result[question.uid].value"> {{option.title}}</div> <div ng-if="option.comments && result[question.uid].value==option.value" style="margin: 0.6em 1.2em"> <textarea placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].comments" rows="4"></textarea> </div> </div> </div> <div ng-if="question.type==\'multiselect\'"> <div ng-repeat="option in question.options"> <div><input type="checkbox" name="question_{{question.uid}}" value="{{option.value}}" ng-model="result[question.uid][option.value].value"> {{option.title}}</div> <div ng-if="option.comments && result[question.uid][option.value].value" style="margin: 0.6em 1.2em"> <textarea placeholder="{{option.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid][option.value].comments" rows="4"></textarea> </div> </div> </div> <div ng-if="question.type==\'text\'"> <textarea placeholder="{{question.placeholder}}" style="width: 100%" ng-model="result[question.uid].value" rows="4"></textarea> </div> <div ng-if="question.comments" style="margin: 0.6em 0em"> <textarea placeholder="{{question.commentsPlaceholder}}" style="width: 100%" ng-model="result[question.uid].questionComments" rows="4"></textarea> </div> </div> </div> <div style="text-align: center"> <button class="btn btn-primary" ng-if="!isFirstSection()" ng-click="goPreviousSection()"><span class="glyphicon glyphicon-chevron-left"></span> {{\'Previous\'|translate}}</button> <button class="btn" ng-if="!isLastSection()" ng-class="{\'btn-primary\':checSection(section)}" ng-disabled="!checSection(section)" ng-click="goNextSection()">{{\'Next\'|translate}} <span class="glyphicon glyphicon-chevron-right"></span></button> <button class="btn" ng-if="isLastSection()" ng-class="{\'btn-primary\':checSection(section)}" ng-disabled="!checSection(section)" ng-click="send()">{{\'Finish\'|translate}} <span class="glyphicon glyphicon-send"></span></button> </div> </div></div>';
		
		return {
			restrict: 'E',
			scope: {
				model:'=',	
				previousValues:'=?',
				result:'=?',
				sendMessage:"=?",
				onFinish:"&",
				reset:"=?"
			},
			controller: controller,
			template:template
		};
	})