/**
LICENSE MIT 2015 Ivan Lausuch ilausuch@gmail.com	
*/

angular.module("il.ui.list", [])
.filter("ilListSanitize", ['$sce', function($sce) {
  return function(htmlCode){
    return $sce.trustAsHtml(htmlCode);
  }
}])
.directive('ilList', function() {
	var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs) {
		byDefault=function(name,value){
			if ($scope[name]==undefined)
				$scope[name]=value;
		}
		
		byDefault("canDelete",false);
		byDefault("autoDelete",true);
		byDefault("canSort",false);
			
		$scope.up=function(pos,item){
			if (pos>0){
				$scope.model[pos]=$scope.model[pos-1];
				$scope.model[pos-1]=item;
				
				if ($scope.onSort!=undefined)
					$scope.onSort({pos:pos,item:item,list:$scope.model})
			}
		}
		
		$scope.down=function(pos,item){
			if (pos<$scope.model.length-1){
				$scope.model[pos]=$scope.model[pos+1];
				$scope.model[pos+1]=item;
				
				if ($scope.onSort!=undefined)
					$scope.onSort({pos:pos,item:item,list:$scope.model})
			}
		}
		
		$scope.delete_=function(pos,item){
			if ($scope.autoDelete){
				if ($scope.deleteConfirm==undefined || confirm($scope.deleteConfirm)){
					$scope.model.splice(pos,1);
					
					if ($scope.onDelete!=undefined)
						$scope.onDelete({pos:pos,item:item,list:$scope.model});
				}
			}
			else
				if ($scope.onDelete!=undefined)
					$scope.onDelete({pos:pos,item:item,list:$scope.model});
		}
		
		$scope._onClick=function(pos,item){
			if ($scope.onClick!=undefined)
				$scope.onClick({pos:pos,item:item,list:$scope.model})
		}
		
		$scope._extraButtonClick=function(pos,item,button){
			if (button.callback!=undefined)
				button.callback(item);
		}
		
	}];
	
	return {
		restrict: 'E',
		scope: {
			model:"=",
			labelField:"=?",
			labelFnc:"&",
			onClick:"&",
			onDelete:"&",
			canDelete:"=?",
			autoDelete:"=?",
			deleteConfirm:"=?",
			canSort:"=?",
			onSort:"&",
			extraButtons:"=?"
		},
		controller: controller,
		template:'<table class="table table-striped"> <tr ng-repeat="(pos,item) in model"> <td style="padding: 1em;cursor:pointer" class="selector" ng-click="_onClick(pos,item)"> <span ng-if="labelField">{{item[labelField]}}</span> <span ng-if="labelFnc" ng-bind-html="labelFnc({item:item,pos:pos})|ilListSanitize"></span> </td> <td ng-if="canSort" style="width: 1em"> <button class="btn btn-info btn-sm" ng-click="up(pos,item)" ng-if="pos>0"> <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span> </button> </td> <td ng-if="canSort" style="width: 1em; padding-left: 0.5em; padding-right: 0.5em;"> <button class="btn btn-info btn-sm" ng-click="down(pos,item)" ng-if="pos<model.length-1"> <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span> </button> </td> <td style="width: 1em; padding-left: 0.5em; padding-right: 0.5em;"> <button class="btn btn-info btn-sm" ng-click="delete_(pos,item)" ng-if="canDelete"> <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> </button> </td> <td style="width: 1em; padding-left: 0.5em; padding-right: 0.5em;" ng-repeat="button in extraButtons"> <button class="btn btn-info btn-sm" ng-click="_extraButtonClick(pos,item,button)"> <span class="glyphicon glyphicon-{{button.icon}}" aria-hidden="true"></span> </button> </td> </tr></table>'
	}
});	