/**
LICENSE MIT 2015 ilausuch@gmail.com	
*/

function ilInputVerificationGroup(){
	this.registry={}
	
	this.register=function(name){
		this.registry[name]=false;	
	}
	
	this.update=function(name,value){
		this.registry[name]=value;	
	}
		
	this.check=function(){
		for (k in this.registry)
			if (this.registry[k]==false)
				return false;
			
		return true;		
	}
}

angular.module("il.ui.input", ['ngSanitize','pascalprecht.translate','ui.bootstrap'])
	.filter('twoDigits', function() {
		return function(input) {
			return input<10 ? "0"+input : input;
		};
	})
	.filter("ilSanitize", ['$sce', function($sce) {
	  return function(htmlCode){
	    return $sce.trustAsHtml(htmlCode);
	  }
	}])
	.filter('filerFullDate', function(){
		return function(input){
			return moment.utc(input).format("LL");
		}
	})
	.filter('filterTimeSeconds', function(){
		return function(input){
			return moment.utc(input).format("LTS");
		}
	})
	.filter('filterTime', function(){
		return function(input){
			return moment.utc(input).format("LT");
		}
	})
	.filter('filterDate', function(){
		return function(input){
			return moment.utc(input).format("LL");
		}
	})
	.filter('filterDateTime', function(){
		return function(input){
			return moment.utc(input).format("LLL");
		}
	})
	.directive('ilInput', function() {
		var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs) {
			if ($scope.type==undefined)
				$scope.type="text"
				
			if ($scope.dateLocale!=undefined)
				moment.locale($scope.dateLocale);
				
			$scope.days=moment.weekdaysMin();
			if (moment.localeData().firstDayOfWeek()==1){
				$scope.days.shift();
				$scope.days.push(moment.weekdaysMin()[0]);
			}
				
			if ($scope.z==undefined)
				$scope.z=10000;
				
			if ($scope.modalOnTop==true)
				$scope.modalStyle={bottom:"1em",backgroundColor:"white"};
			else
				$scope.modalStyle={top: "0px",backgroundColor:"white"};
				
				
			if ($scope.type=="time" || $scope.type=="dateTime" ){
				$scope.hours=[];
				for (var r=0; r<6; r++){
					$scope.hours[r]=[];
					for (var c=0; c<4; c++)
						$scope.hours[r][c]=c+r*4;
				}
				
				$scope.minutes=[];
				for (var r=0; r<6; r++){
					$scope.minutes[r]=[];
					for (var c=0; c<10; c++)
						$scope.minutes[r][c]={v:c+r*10,k:(c+r*10)%15==0};
				}
			}
			
			if ($scope.booleanTrue==undefined)
				$scope.booleanTrue=true;
				
			if ($scope.booleanFalse==undefined)
				$scope.booleanFalse=false;
				
			if ($scope.booleanTrueHtml==undefined)
				$scope.booleanTrueHtml='<span class="glyphicon glyphicon-check"></span>';
			
			if ($scope.booleanFalseHtml==undefined)
				$scope.booleanFalseHtml='<span class="glyphicon glyphicon-unchecked"></span>';
				
		
			if ($scope.verifyGroup!=undefined)
				$scope.verifyGroup.register($scope.field);
		
			//Functions --->
			
			$scope.undefinedIs=function(value,defaultValue){
				if (value==undefined)
					return defaultValue;
				else
					return value;
			}
				
			$scope.isDisable=function(){
				return false;
			}
			
			$scope.clickToEdit=function(){
				$scope.editMode=true;
			}
			
			$scope.getValue=function(){
				if ($scope.model==undefined || $scope.model[$scope.field]==undefined)
					return "";
					
				if ($scope.type=="date"||$scope.type=="dateTime"||$scope.type=="time"){
					var date=$scope.model[$scope.field];
					
					if (date==undefined)
						return moment();
					else
						return moment(moment.utc(date),"es");
				}
				else
					return $scope.model[$scope.field];
			}
			
			$scope.$watch("model."+$scope.field,function updateModel(){
				$scope.checkValidate();
			});
			
			$scope._validated=false;
			
			$scope.checkValidate=function(){
				$scope._validated=true;
				
				if ($scope.verifyGroup!=undefined)
					$scope.verifyGroup.update($scope.field,true);

				
				if ($scope.required){
					switch($scope.type){
						case "text":
						case "password":
							if ($scope.getValue()==undefined || $scope.getValue()==""){
								$scope._validated=false;
								
								if ($scope.verifyGroup!=undefined)
									$scope.verifyGroup.update($scope.field,false);
								
								return;
							}
						break;
						
						case "select":
						case "date":
						case "dateTime":
							if ($scope.model[$scope.field]==undefined){
								$scope._validated=false;
								
								if ($scope.verifyGroup!=undefined)
									$scope.verifyGroup.update($scope.field,false);
								
								return;
							}
						break;
					}
				}	
					
				if ($scope.type=="text" || $scope.type=="password"){
					if ($scope.textVerifyInt && parseInt($scope.getValue())!=$scope.getValue()){
						$scope._validated=false;
						
						if ($scope.verifyGroup!=undefined)
							$scope.verifyGroup.update($scope.field,false);
						
						return;
					}
					
					if ($scope.textVerifyFloat && parseFloat($scope.getValue())!=$scope.getValue()){
						$scope._validated=false;
						
						if ($scope.verifyGroup!=undefined)
							$scope.verifyGroup.update($scope.field,false);
						
						return;
					}
				}
				

				if ($scope._validated && $scope.verifyFnc!=undefined){
					valid=$scope.verifyFnc({model:$scope.model,value:$scope.getValue()});

					if (valid!=undefined)
						$scope._validated=valid;
						
					if ($scope.verifyGroup!=undefined)
						$scope.verifyGroup.update($scope.field,$scope._validated);	
				}
									
				if ($scope.onVerify!=undefined)
					$scope.onVerify({valid:$scope._validated,model:$scope.model,value:$scope.getValue()});
				
			}
			
			$scope._onChange=function(){
				$scope.checkValidate();
				if ($scope._validated)
					$scope.onChange();
			}
			
			$scope.checkValidate();
			
			$scope._selectValueFnc=function(item){
				var v=$scope.selectValueFnc({item:item,model:$scope.model});
				if (v!=undefined)
					return v;
				
				if ($scope.selectValueField!=undefined)
					return item[$scope.selectValueField];
					
				return item;
			}	
			
			$scope._selectLabelFnc=function(item){
				var v=$scope.selectLabelFnc({item:item,model:$scope.model});
				if (v!=undefined)
					return v;
				
				if ($scope.selectLabelField!=undefined)
					return item[$scope.selectLabelField];
					
				return item;
			}
			
			$scope.date_getMonth=function(){
				if ($scope.date_selected!=undefined)
					return $scope.date_selected.format("MMMM");
			}
			
			$scope.date_getYear=function(){
				if ($scope.date_selected!=undefined)
					return $scope.date_selected.format("YYYY");
			}
			
			
			$scope.date_prepareCalendar=function(){
				date=$scope.date_selected;
				firstWeekday = new Date(date.year(), date.month(), 1).getDay();
				lastDateOfMonth = new Date(date.year(), date.month() + 1, 0).getDate();
				if (firstWeekday==0)
					firstWeekday=7;
				
				$scope.weeks=[];
				
				for(w=0;w<6;w++){
					$scope.weeks[w]=[];
					for(d=0;d<7;d++){
						var _d=w*7+d-firstWeekday+2;
						if (_d<=0 || _d>lastDateOfMonth)
							$scope.weeks[w][d]={label:""};
						else{
							var nd=moment({y:date.year(),M:date.month(),d:_d+1});
							$scope.weeks[w][d]={
								label:_d,
								date:nd,
								selected:nd.isSame($scope.getValue(),"day") 
										&& nd.isSame($scope.getValue(),"month") 
										&& nd.isSame($scope.getValue(),"year") 
							};
						}
						
					}
				}
			}
			
			$scope.date_openModal=function(){
				$scope.date_selected=$scope.getValue();	
					
				if ($scope.date_showModal==undefined || !$scope.date_showModal){
					$scope.date_showModal=true;
					$scope.date_prepareCalendar();		
				}
				else{
					$scope.date_showModal=false;
				}		
			}
			
			$scope.date_selectDate=function(d){
				$scope.date_showModal=false;
				
				if ($scope.type=="date"){
					var set=false;
					try{
						$scope.model[$scope.field].setFullYear(d.date.year());
						$scope.model[$scope.field].setMonth(d.date.month());
						$scope.model[$scope.field].setDate(d.date.day());
						set=true;
					}catch(e){}
					
					if (!set)
						try{
							$scope.model[$scope.field]=d.date;
						}catch(e){}
						
					$scope._onChange();
				}else
					$scope.time_openModal();
			}
			
			$scope.date_previousMonth=function(){
				$scope.date_selected.subtract(1,'month');
				$scope.date_prepareCalendar();
			}
			
			$scope.date_nextMonth=function(){
				$scope.date_selected.add(1,'month');
				$scope.date_prepareCalendar();
			}
			
			$scope.time_openModal=function(){
				$scope.time_showModal=true;
				$scope.time_step="h";
				$scope.time_selected={h:0,m:0,s:0};
			}
			
			$scope.time_select=function(v){
				if ($scope.time_step=="h"){
					$scope.time_selected.h=v;
					$scope.time_step="m";	
					return;
				}
				
				if ($scope.time_step=="m"){
					$scope.time_selected.m=v;
					
					if ($scope.timeSeconds){
						$scope.time_step="s";
						return;	
					}	
				}
				
				if ($scope.time_step=="s")
					$scope.time_selected.s=v;
					
				$scope.time_showModal=false;
				$scope.model[$scope.field].setHours($scope.time_selected.h);
				$scope.model[$scope.field].setMinutes($scope.time_selected.m);
				$scope.model[$scope.field].setSeconds($scope.time_selected.s);
				
				$scope._onChange();
			}
			
			$scope.dateTime_openModal=function(){
				$scope.date_openModal();
			}
			
			$scope.boolean_tonggle=function(){
				if ($scope.model[$scope.field]==$scope.booleanTrue)
					$scope.model[$scope.field]=$scope.booleanFalse;
				else
					$scope.model[$scope.field]=$scope.booleanTrue;
					
				this._onChange();
			}
			
		}];
		
		template='<div ng-if="onlyText" ng-click="clickToEdit()" style="cursor:pointer"> <div ng-if="type==\'time\'"> <span ng-if="!timeSeconds">{{model[field]|filterTime}}</span> <span ng-if="timeSeconds">{{model[field]|filterTimeSeconds}}</span> </div> <div ng-if="type==\'date\'"> {{model[field]|filterDate}} </div> <div ng-if="type==\'dateTime\'"> {{model[field]|filterDateTime}} </div> <div ng-if="type==\'boolean\'"> <div ng-if="model[field]==booleanTrue" ng-bind-html="booleanTrueHtml | ilSanitize"></div> <div ng-if="model[field]!=booleanTrue" ng-bind-html="booleanFalseHtml | ilSanitize"></div> </div> <div ng-if="type==\'select\'"> {{_selectLabelFnc(model[field])}} </div> <div ng-if="type==\'text\'"> {{model[field]}} </div> <div ng-if="type==\'password\'"> ********* </div> </div><div ng-if="!onlyText" class="form-group has-feedback" ng-class="{\'has-success\':_validated && undefinedIs(verifyShow,true), \'has-error\':!_validated && undefinedIs(verifyShow,true)}"> <label ng-if="label" class="control-label">{{label}}</label> <div class="input-group" style="width: 100%"> <span class="input-group-addon" ng-if="innerLabel">{{innerLabel}}</span> <span class="input-group-addon" ng-if="innerIcon"> <span class="glyphicon glyphicon-{{innerIcon}}"></span> </span> <span class="input-group-addon" ng-if="innerAwesomeIcon"> <span class="fa fa-{{innerAwesomeIcon}}"></span> </span> <input ng-if="type==\'text\'" type="text" class="form-control" ng-model="model[field]" ng-change="_onChange()"> <input ng-if="type==\'password\'" type="password" class="form-control" ng-model="model[field]" ng-change="_onChange()"> <div ng-if="type==\'time\'" class="form-control" ng-click="time_openModal()"> <span ng-if="!timeSeconds">{{model[field]|filterTime}}</span> <span ng-if="timeSeconds">{{model[field]|filterTimeSeconds}}</span> </div> <select ng-if="type==\'select\'" class="form-control" ng-model="model[field]" ng-options="_selectValueFnc(item) as _selectLabelFnc(item) for item in selectOptions" ng-change="_onChange()" style="-webkit-appearance: none; -moz-appearance:none;padding: 0px"></select> <div ng-if="type==\'date\'" class="form-control" ng-click="date_openModal()" style="cursor: pointer"> {{model[field]|filterDate}} </div> <div ng-if="type==\'dateTime\'" class="form-control" ng-click="dateTime_openModal()" style="cursor: pointer"> {{model[field]|filterDateTime}} </div> <div ng-if="type==\'boolean\'" class="form-control"> <div ng-if="model[field]==booleanTrue" ng-click="boolean_tonggle()" style="cursor: pointer" ng-bind-html="booleanTrueHtml | ilSanitize"></div> <div ng-if="model[field]!=booleanTrue" ng-click="boolean_tonggle()" style="cursor:pointer" ng-bind-html="booleanFalseHtml | ilSanitize"></div> </div> <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="_validated && undefinedIs(verifyShow,true)" aria-hidden="true"></span> <span class="glyphicon glyphicon-remove form-control-feedback" ng-if="!_validated && undefinedIs(verifyShow,true)" aria-hidden="true"></span> </div> <!-- MODALS --> <div ng-if="type==\'date\'||type==\'dateTime\'" style="position: relative" ng-show="date_showModal"> <div style="position: absolute; border-color: silver; z-index: {{z}}; left: 0px; right: 0px;" ng-style="modalStyle"> <table class="table table-condensed" style="text-align: center !important; border:1px solid silver"> <tr> <td ng-click="date_previousMonth()" style="cursor: pointer">&lt;</td> <td colspan="5">{{date_getMonth()}} {{date_getYear()}}</td> <td ng-click="date_nextMonth()" style="cursor: pointer">&gt;</td> </tr> <tr> <td ng-repeat="day in days">{{day}}</td> </tr> <tr ng-repeat="w in weeks"> <td ng-repeat="d in w" style="cursor: pointer" ng-click="date_selectDate(d)"> <span style="color:gray" ng-if="!d.selected">{{d.label}}</span> <span ng-if="d.selected" class="label label-primary">{{d.label}}</span> </td> </tr> </table> </div> </div> <div ng-if="type==\'time\'||type==\'dateTime\'" style="position: relative" ng-show="time_showModal"> <div style="position: absolute; border-color: silver; z-index: {{z}}; left: 0px; right: 0px;" ng-style="modalStyle" ng-show="time_step==\'h\'"> <table class="table table-condensed" style="text-align: center !important; border:1px solid silver"> <tr> <td colspan="{{hours[0].length}}">??:00<span ng-if="timeSeconds">:00</span> </td> </tr> <tr ng-repeat="r in hours"> <td ng-repeat="i in r" style="cursor:pointer" ng-click="time_select(i)">{{i}}</td> </tr> </table> </div> <div style="position: absolute; border-color: silver; z-index: {{z}}; left: 0px; right: 0px;" ng-style="modalStyle" ng-show="time_step==\'m\'"> <table class="table table-condensed" style="text-align: center !important; border:1px solid silver"> <tr> <td colspan="{{minutes[0].length}}">{{time_selected.h}}:?? <span ng-if="timeSeconds">:00</span> </td> </tr> <tr ng-repeat="r in minutes"> <td ng-repeat="i in r" style="cursor:pointer" ng-click="time_select(i.v)"> <span ng-if="i.k" style="color:blue">{{i.v|twoDigits}}</span> <span ng-if="!i.k">{{i.v|twoDigits}}</span> </td> </tr> </table> </div> <div style="position: absolute; border-color: silver; z-index: {{z}}; left: 0px; right: 0px;" ng-style="modalStyle" ng-show="time_step==\'s\'"> <table class="table table-condensed" style="text-align: center !important; border:1px solid silver"> <tr> <td colspan="{{minutes[0].length}}">{{time_selected.h|twoDigits}}:{{time_selected.m|twoDigits}}:??</td> </tr> <tr ng-repeat="r in minutes"> <td ng-repeat="i in r" style="cursor:pointer" ng-click="time_select(i.v)"> <span ng-if="i.k" style="color:blue">{{i.v|twoDigits}}</span> <span ng-if="!i.k">{{i.v|twoDigits}}</span> </td> </tr> </table> </div> </div><!-- </div></div>-->';
		
		return {
			restrict: 'E',
			scope: {
	              model:'=',
	              field:"=",
	              type:'=?',
	              onlyText:'=?',
	              z:'=?',
	              verifyShow:'=?',
	              
				  onChange:'&',
	              verifyFnc:"&",
	              onVerify:"&",
	              verifyGroup:"=?",
	              
	              label:"=?",
	              innerLabel:"=?",
	              innerIcon:"=?",
	              innerAwesomeIcon:"=?",
	              
	              required:"=?",
	              
	              textVerifyInt:"=?",
	              textVerifyFloat:"=?",
	              
				  timeSeconds:"=?",

				  selectVerifyRequired:"=?",
				  selectOptions:"=?",
				  selectLabelField:"=?",
				  selectLabelFnc:"&?",
				  selectValueField:"=?",
				  selectValueFnc:"&?",
				  
				  dateLocale:"=?",
				  
				  modalOnTop:"=?",
				  
				  booleanTrue:"=?",
				  booleanFalse:"=?",
				  booleanTrueHtml:"=?",
				  booleanFalseHtml:"=?",
				  
	              
			},
			controller: controller,
			template:template
		};
	});