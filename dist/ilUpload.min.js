/**
LICENSE MIT 2015 ilausuch@gmail.com	
*/

/*
function ilUpload_CustomDemo(secret){
	this.secret=secret;
	
	this.pick=function(successCallback,errorCallback){
		//On success call to successCallback with an object with (url,filename,mimetype,size)
		//On error call to errorCallback with an error text
	}
}
*/

function ilUpload_FilePiker(secret,config){
	this.secret=secret;
	
	if (config==undefined)
		this.config={};
	else
		this.config=config;
	
	this.pick=function(successCallback,errorCallback){
		filepicker.setKey(this.secret);
		filepicker.pick(config,
			function(Blob){
				successCallback(Blob)
			},
			function(FPError){
				errorCallback("Error uploading file")
			}
		);
	}
	
	//mimetype: 'image/*',
	//services: ['COMPUTER', 'FACEBOOK', 'CLOUDAPP']			
}

angular.module("il.ui.upload", ['ngSanitize','pascalprecht.translate','ui.bootstrap'])
	.directive('ilUpload', function() {
		var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs) {
						$scope.defaultValue=function(varName,value){
				if ($scope[varName]==undefined)
					$scope[varName]=value;
			}
			
			$scope.defaultValue=function(varName,value){
				if ($scope[varName]==undefined)
					$scope[varName]=value;
			}
			
			$scope.defaultValue("multiple",false);
			
			$scope.model[$scope.field]=[];
							
			$scope.getFiles=function(){
				return $scope.model[$scope.field];
			}
			
			
			$scope.getSize=function(file){
				if (file.size/(1024*1024)>=1)
					return "" + Math.round(100*file.size/(1024*1024))/100 + " Mb.";
				else if (file.size/(1024)>=1)
					return "" + Math.round(file.size/1024) + " Kb.";
				else
					return "" + file.size + " bytes";
			}
			
			$scope.isImage=function(file){
				switch(file.mimetype){
					case "image/png":
					case "image/jpg":
					case "image/jpeg":
					case "image/gif":
						return true;
					break;
					default:
						return false;
				}
			}
			
			$scope.getMimeAwesomeClass=function(file){
				switch($scope.getExtension(file)){
					case "zip":
					case "rar":
					case "tar":
					case "tgz":
						return "fa-file-zip-o";
					break;	
					case "doc":
					case "docx":
						return "fa-file-word-o";
					break;
					case "xls":
					case "xlsx":
						return "fa-file-excel-o";
					break;
					case "txt":
						return "fa-file-text-o";
					break;
					case "pdf":
					case "pdfx":
						return "fa-file-pdf-o"
					break;
					case "mp3":
						return "fa-file-audio-o";
					break;
					case "mp4":
					case "avi":
					case "mov":
					case "mpg":
						return "fa-file-video-o";
					break;
					case "tiff":
					case "bmp":
						return "fa-file-picture-o";
					break;
					default:
						return "fa-file-o";
				}
			}
			
			$scope.getExtension=function(file){
				v=file.filename.split(".")
				return v[v.length-1];
			}
			
			$scope.getMime=function(file){
				switch($scope.getExtension(file)){
					case "zip":
					case "rar":
					case "tar":
					case "tgz":
						return "Compressed file";
					break;	
					case "doc":
					case "docx":
						return "Word";
					break;
					case "xls":
					case "xlsx":
						return "Excel";
					break;
					case "txt":
						return "Text file";
					break;
					case "pdf":
					case "pdfx":
						return "PDF"
					break;
					case "mp3":
						return "audio";
					break;
					case "mp4":
					case "avi":
					case "mov":
					case "mpg":
						return "video";
					break;
					case "tiff":
					case "bmp":
						return "image";
					break;
					default:
						return "file";
				}
			}
			
			
			$scope.pick=function(){
				$scope.system.pick(
					function(file){
						if (!$scope.multiple)
							$scope.model[$scope.field]=[];
							
						$timeout(function(){
							$scope.model[$scope.field].push(file);
							
							if ($scope.onChange!=undefined)
								$scope.onChange({list:$scope.getFiles()});
						})
						
						
					},
					function(errorText){
						if (console) console.debug("Error",errorText);
					}
				);
			}
			
			$scope.removeFile=function(file){
				if (confirm("Are you sure?")){
					list=$scope.getFiles();
					for (i=0; i<list.length; i++)
						if (list[i]==file)
							list.splice(i,1);
				
					if ($scope.onChange!=undefined)
						$scope.onChange($scope.getFiles());
				}
			}
		
		}];
		
		template='<div> <!-- <div ng-if="!multiple"> <table class="table"> <tr ng-if="model[field].length==0"> <td colspan="3" style="vertical-align: middle"> {{\'No file\'|translate}} </td> <td style="vertical-align: middle"> <button type="button" class="btn btn-primary" ng-click="pick()">{{\'Select file\'|translate}}</button> </td> </tr> <tr ng-if="model[field].length>0"> <td style="vertical-align: middle"> <img ng-if="isImage(model[field][0])" ng-src="{{model[field][0].url}}" style="max-height: 3em; max-width: 10em"> <span ng-if="!isImage(model[field][0])"><i class="fa" ng-class="getMimeAwesomeClass(model[field][0])" style="margin-right: 0.5em"></i> {{getMime(model[field][0])}}</span> </td> <td style="vertical-align: middle"> {{model[field][0].filename}} </td> <td style="vertical-align: middle"> {{getSize(model[field][0])}} </td> <td style="vertical-align: middle"> <button type="button" class="btn btn-primary" ng-click="pick()">{{\'Change file\'|translate}}</button> </td> </tr> </table> </div> <div ng-if="multiple"> --> <table class="table"> <tr ng-if="model[field].length>0 && userFields"> <td colspan="3"></td> <th ng-repeat="field in userFields" style="text-align: center"> {{field.label}} </th> <td></td> </tr> <tr ng-repeat="file in model[field]"> <td style="vertical-align: middle; text-align: center"> <img ng-if="isImage(file)" ng-src="{{file.url}}" style="max-height: 3em; max-width: 10em"> <span ng-if="!isImage(file)"><i class="fa" ng-class="getMimeAwesomeClass(file)" style="margin-right: 0.5em"></i> {{getMime(file)}}</span> </td> <td style="vertical-align: middle"> {{file.filename}} </td> <td style="vertical-align: middle"> {{getSize(file)}} </td> <td ng-repeat="field in userFields" style="vertical-align: middle; text-align: center"> <select ng-if="field.type==\'combobox\'" ng-model="file[\'user_\'+field.id]" ng-options="op.value as op.label for op in field.options"></select> <textarea ng-if="field.type==\'text\'" ng-model="file[\'user_\'+field.id]" style="width: 100%"></textarea> <input type="checkbox" ng-if="field.type==\'checkbox\'" ng-model="file[\'user_\'+field.id]"> </td> <td style="vertical-align: middle"> <span class="glyphicon glyphicon-trash" style="cursor:pointer" ng-click="removeFile(file)"></span> </td> </tr> </table> <div style="width: 100%; text-align: center"> <p ng-if="model[field].length==0">{{\'No files\'|translate}}</p> <button type="button" class="btn btn-primary" ng-click="pick()">{{\'Select file\'|translate}}</button> </div> <!-- </div> --></div>';
		
		return {
			restrict: 'E',
			scope: {
				model:'=',
				field:"=",
				system:"=",
				multiple:"=?",
				userFields:"=?",
				onChange:"&",			  
			},
			controller: controller,
			template:template
		};
	});