/**
LICENSE MIT 2015 ilausuch@gmail.com	
*/

/*
function ilUpload_CustomDemo(secret){
	this.secret=secret;
	
	this.pick=function(successCallback,errorCallback){
		//On success call to successCallback with an object with (url,filename,mimetype,size)
		//On error call to errorCallback with an error text
	}
}
*/

angular.module("il.ui.upload", ['ngSanitize','pascalprecht.translate','ngFileUpload','il.ui.modal'])
	.directive('ilUpload', function() {
		var controller = ['$scope','$timeout','$attrs', function ($scope,$timeout,$attrs,Upload) {
			$scope.uploading=false;
			$scope.error=false;
			$scope.percent="0%";
			
			$scope.upload = function(files) {
				uploading=true;
				
				files.forEach(function(file){
					console.debug("Uploading",file);
					Upload.upload({
						url: $scope.url,
						file: file
					}).then(function(resp) {// file is uploaded successfully
						console.debug(resp);
						$scope.show=false;
					}, function(resp) { // handle error
						$scope..error=true;
						$scope.uploading=false;
						console.debug("Error",resp);
					}, function(evt) {// progress notify
						$scope.percent=""+parseInt(100.0 * evt.loaded / evt.total)+ '%';
					});
				});
			    
			}
		
		}];
		
		template='<il-modal show="show" title="\'Upload a file\'" on-cancel="show=false" auto-close="true" footer-visible="false" close-visible="!uploading"> <div style="text-align: center; height: 200px"> <div ng-show="!uploading && !error" ngf-drop ng-model="files" style="width: 100%; height: 200px; background-color: #F9F9F9; border: 3px dotted silver" ngf-change="upload($files)"> <div style="position: relative; top:65px"> <button class="btn btn-primary" ngf-select ng-model="mc.files" ngf-change="upload($files)">Select a file</button> <p style="font-size: 140%; color: silver; margin-top: 10px">or drop here a file</p> </div> </div> <div ng-show="uploading" style="padding-top: 50px"> <span >Uploading...</span> <div style="margin:0 auto; padding: 1px; border: 1px solid silver; width: 80%;"> <div style="width: 0%;height: 18px;background: #286090;" ng-style="{ width: percent }"></div> </div> </div> <div ng-show="error" style="padding-top: 50px"> <p style="color:red">Error uploading file</p> <button class="btn btn-primary" ng-click="error=false">Retry</button> </div> </div></il-modal>';
		
		return {
			restrict: 'E',
			scope: {
				url:'=',
				show:'=',
				onUploaded:"&",			  
			},
			controller: controller,
			template:template
		};
	});